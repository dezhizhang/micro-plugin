{"version":3,"file":"index.js","sources":["../../src/applications/app.helpers.js","../../src/lifecycles/bootstrap.js","../../src/lifecycles/load.js","../../src/lifecycles/unmount.js","../../src/start.js","../../src/navigations/reroute.js","../../src/applications/app.js"],"sourcesContent":["// 描述应用的整个状态\n\n// 应用初始化\nexport const NOT_LOADED = 'NOT_LOADED';\n// 加载资源\nexport const LOADING_SOURCE_CODE = 'LOADING_SOURCE_CODE';\n// 应用还没有调用bootstrap\nexport const NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED';\n//启动中\nexport const BOOTSTRAPPING = 'BOOTSTRAPPING';\n// 没有调用mount方法\nexport const NOT_MOUNTED = 'NOT_MOUNTED';\n//加载应用\nexport const MOUNTED = 'MOUNTED';\n// 正在挂载中\nexport const MOUNTING = 'MOUNTING';\n// 更新中\nexport const UPDATINMG = 'UPDATINMG';\n//自裁中\nexport const UNMOUNTING = 'UNMOUNTING';\n// 完全绡\nexport const UNLOADING = 'NLOADING';\n// 文件加载失败\nexport const LOAD_ERR = 'LOAD_ERR';\n// 代码出错\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN';\n\n// 当前应用是否被激活\nexport function isAactive(app) {\n    app.status === NOT_MOUNTED\n}\n\n// 当前应用是否要被激活\nexport function shouldBeActive(app) {\n    return app.activeWhen(window.location);\n}\n\n","import { BOOTSTRAPPING, NOT_BOOTSTRAPPED } from \"../applications/app.helpers\";\n\n\nexport function toBootstrapPromise(app) {\n    if(app.status !== NOT_BOOTSTRAPPED) {\n        return app;\n    }\n\n    app.status = BOOTSTRAPPING;\n    \n    // app.status = \n}","import { LOADING_SOURCE_CODE, NOT_BOOTSTRAPPED } from \"../applications/app.helpers\";\n\n\n\nfunction flattenFnArray(fns) {\n    fns = Array.isArray(fns) ? fns : [fns];\n\n    return (props) => fns.reduce((p, fn) => p.then(() => fn(props)), Promise.resolve())\n}\n\nexport async function toLoadPromise(app) {\n    app.status = LOADING_SOURCE_CODE;\n    let { bootstrap, mount, unmount } = await app.loadApp(app.custormProps);\n\n    app.status = NOT_BOOTSTRAPPED;\n    app.bootstrap = flattenFnArray(bootstrap);\n    app.mount = flattenFnArray(mount);\n    app.unmount = flattenFnArray(unmount);\n    return app;\n}\n","import { MOUNTED, NOT_MOUNTED, UNMOUNTING } from \"../applications/app.helpers\";\n\nexport async function toUnmountPromise(app) {\n    if (app.status !== MOUNTED) {\n        return app;\n    }\n\n    app.status = UNMOUNTING\n    await app.unmount(app.customProps);\n    app.status = NOT_MOUNTED;\n    return app;\n\n}","import { reroute } from \"./navigations/reroute\";\n\n// 是否被加载\nexport let started = false;\n\nexport function start() {\n    started = true;\n    // 加载应用\n    reroute();\n}\n\n","import { getAppChanges } from \"../applications/app\";\nimport { toBootstrapPromise } from \"../lifecycles/bootstrap\";\nimport { toLoadPromise } from \"../lifecycles/load\";\nimport { toUnmountPromise } from '../lifecycles/unmount';\nimport { started } from \"../start\";\n\n\nexport function reroute() {\n    const { appsToLoad, appsToMount, appsToUnmount } = getAppChanges();\n    console.log(appsToLoad, appsToMount, appsToUnmount)\n    if (started) {\n        // 装载\n        return performAppChanges();\n    } else {\n        // 注册应用时需要预先加载\n        return loadApps();\n    }\n\n    async function loadApps() {\n        let apps = await Promise.all(appsToLoad.map(toLoadPromise));\n        console.log('apps',apps);\n\n    }\n\n    async function performAppChanges() {\n       let unmountPromise = appsToUnmount.map(toUnmountPromise);\n       appsToLoad.map(async (app) => {\n           app = await toLoadPromise(app);\n           app = await toBootstrapPromise(app);\n           return await toMmountPromise(app)\n       })\n    }\n}\n","\n\n/**\n * @param {*} appName 应用名称\n * @param {*} loadApp 加载应用\n * @param {*} activeWhen 当前激活的应用\n * @param {*} customProps 自定义属性\n*/\n\nimport { reroute } from \"../navigations/reroute\";\nimport { BOOTSTRAPPING, LOADING_SOURCE_CODE, NOT_BOOTSTRAPPED, NOT_LOADED, NOT_MOUNTED, shouldBeActive, MOUNTED } from \"./app.helpers\";\n\n// 用来存放所有应用\nconst apps = [];\n\nexport function registerApplication(appName, loadApp, activeWhen, customProps) {\n    apps.push({\n        name: appName,\n        loadApp,\n        activeWhen,\n        customProps,\n        status: NOT_LOADED\n    });\n\n    reroute();\n\n}\n\nexport function getAppChanges() {\n    const appsToUnmount = []; // 要自裁的app\n    const appsToLoad = []; // 要加载的app\n    const appsToMount = []; // 需要挂载\n\n    apps.forEach(app => {\n        const appShouldBeActive = shouldBeActive(app);\n        switch (app.status) {\n            case NOT_LOADED:\n            case LOADING_SOURCE_CODE:\n                if (appShouldBeActive) {\n                    appsToLoad.push(app);\n                }\n                break;\n            case NOT_BOOTSTRAPPED:\n            case BOOTSTRAPPING:\n            case NOT_MOUNTED:\n                if (appShouldBeActive) {\n                    appsToMount.push(app);\n\n                }\n                break;\n            case MOUNTED:\n                if (!appShouldBeActive) {\n                    appsToUnmount.push(app);\n                }\n            default:\n\n        }\n    })\n    return { appsToUnmount, appsToLoad, appsToMount }\n}\n\n"],"names":[],"mappings":"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"}